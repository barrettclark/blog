  <!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> Creating a private, commercial Docker registry </title>
    
    <link rel="stylesheet" href="https://www.mikeperham.com/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://www.mikeperham.com/css/theme.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/headshot-icon.png">
    <link rel="shortcut icon" href="/favicon.ico">
    
    
    
    <link href="https://www.mikeperham.com/index.xml" rel="home" type="application/rss+xml" title="Mike Perham" />
    
</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-right">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://www.mikeperham.com">Mike Perham</a>
    </div>
    <div class="collapse navbar-collapse" id="navbar-right">
      <ul class="nav navbar-nav navbar-right">
        
          <li><a href="https://sidekiq.org/" >Sidekiq</a></li>
        
          <li><a href="http://contribsys.com/faktory/" >Faktory</a></li>
        
          <li><a href="/events/" >Events</a></li>
        
          <li><a href="/about/" >About</a></li>
        
        
        <li><a href="https://www.mikeperham.com/index.xml" title="RSS" type="application/rss+xml" target="_blank"><i class="fa fa-fw fa-rss"></i></a></li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="container page-wrap">
      <h1>Creating a private, commercial Docker registry</h1>
      <small class="post-meta">Mar 9, 2020</small>
      <div class="post-content">
        

<p>One thing I've come to respect about containers are how easy they make
packaging and running Linux infrastructure.  No more fighting the distro
for the right version of a package, a dozen builds for a dozen
distro-specific packages, etc.  Everything is encapsulated within a
single container image that runs on any modern Linux.</p>

<p>It hasn't escaped my notice that most of my Faktory users are using the
<a href="https://hub.docker.com/r/contribsys/faktory">Docker image</a> to run Faktory which means that most of my Faktory Pro and
Enterprise customers will want a Docker image too. How do I distribute
Docker images which contain my commercial builds? <strong>Run my own Docker
image registry!</strong> Here's how.</p>

<h2 id="install-docker-on-your-server">Install Docker on your Server</h2>

<p>Docker provides a container image with their <a href="https://hub.docker.com/_/registry">proprietary registry
server</a> along with <a href="https://docs.docker.com/registry/deploying/">documentation on
how to use it</a>. It's not
open source but it is Apache licensed so anyone can run it for any
purpose.</p>

<p>I wasn't too happy with this step -- I don't like adding moving parts to my production servers -- but there wasn't any other supported deployment mechanism.
I developed this set of commands to install Docker and the registry image.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">apt-get install -y gnupg-agent software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
add-apt-repository <span style="color:#e6db74">&#34;deb [arch=amd64] https://download.docker.com/linux/ubuntu </span><span style="color:#66d9ef">$(</span>lsb_release -cs<span style="color:#66d9ef">)</span><span style="color:#e6db74"> stable&#34;</span>
apt-get install -y docker-ce docker-ce-cli containerd.io
docker pull registry:2</code></pre></div>
<p>Protip: don't copy this, what I did in January 2020 can easily change.
Follow the Linux install directions on docker.com.</p>

<pre><code>a2enmod headers proxy proxy_http
</code></pre>

<p>Proxying the registry required me to activate these Apache modules. YMMV.</p>

<h2 id="configure-apache-proxy">Configure Apache Proxy</h2>

<p>I used small portions of the <a href="https://docs.docker.com/registry/recipes/apache/">Apache recipe</a> provided by Docker.
Take some time to read it carefully.
The core are these lines:</p>

<pre><code>  ProxyPass        /v2 http://localhost:5000/v2
  ProxyPassReverse /v2 http://localhost:5000/v2
</code></pre>

<p>The registry listens on localhost:5000. Apache proxies any /v2 requests to this port.</p>

<p>I have an atypical usecase: I have Faktory Pro customers and Faktory Enterprise customers.
Both should be able to access the registry but the general public should not.
How can I configure Apache to authenticate users from list A or list B?
Turns out it was pretty easy with a single trick: <code>AuthBasicProvider</code> allows multiple sources.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-apache" data-lang="apache"><span style="color:#75715e"># sites-enabled/auth.conf</span>
<span style="color:#f92672">&lt;AuthnProviderAlias</span> <span style="color:#e6db74">file fpro</span><span style="color:#f92672">&gt;</span>
	AuthUserFile <span style="color:#e6db74">&#34;/var/fpro.passwd&#34;</span>
<span style="color:#f92672">&lt;/AuthnProviderAlias&gt;</span>

<span style="color:#f92672">&lt;AuthnProviderAlias</span> <span style="color:#e6db74">file fent</span><span style="color:#f92672">&gt;</span>
	AuthUserFile <span style="color:#e6db74">&#34;/var/fent.passwd&#34;</span>
<span style="color:#f92672">&lt;/AuthnProviderAlias&gt;</span>

<span style="color:#75715e"># sites-enabled/registry.example.com.conf</span>
<span style="color:#f92672">&lt;VirtualHost</span> <span style="color:#e6db74">*:443</span><span style="color:#f92672">&gt;</span>
  ServerName <span style="color:#66d9ef">registry</span>.example.com

  <span style="color:#75715e"># ... other bits removed ...</span>

  ProxyPass        <span style="color:#e6db74">/v2</span> http://localhost:5000/v2
  ProxyPassReverse <span style="color:#e6db74">/v2</span> http://localhost:5000/v2

  <span style="color:#f92672">&lt;Location</span> <span style="color:#e6db74">/v2</span><span style="color:#f92672">&gt;</span>
    Order deny,allow
    Allow from <span style="color:#66d9ef">all</span>
    AuthName <span style="color:#e6db74">&#34;Registry Authentication&#34;</span>
    AuthType basic
    AuthBasicProvider fpro fent
    Require valid-user

    <span style="color:#f92672">&lt;Limit</span> <span style="color:#e6db74">POST PUT DELETE PATCH</span><span style="color:#f92672">&gt;</span>
      Deny from <span style="color:#66d9ef">all</span>
    <span style="color:#f92672">&lt;/Limit&gt;</span>
  <span style="color:#f92672">&lt;/Location&gt;</span>
<span style="color:#f92672">&lt;/VirtualHost&gt;</span></code></pre></div>
<p>Note that write verbs are 100% denied. So with this one block of
configuration we:</p>

<ol>
<li>limit access to fpro and fent customers</li>
<li>enforce read-only access</li>
</ol>

<h2 id="pushing-new-images">Pushing New Images</h2>

<p>If Apache limits access to read only, how do we push new images?
Use an SSH tunnel to bypass Apache!
Since the registry listens on localhost:5000, I build the image on my laptop, open an SSH tunnel to localhost:5000 on the server and push new image:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ssh -N -f -L <span style="color:#ae81ff">5000</span>:localhost:5000 root@registry.example.com
sleep <span style="color:#ae81ff">2</span>
docker tag example/<span style="color:#66d9ef">$(</span>NAME<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>VERSION<span style="color:#66d9ef">)</span> host.docker.internal:5000/example/<span style="color:#66d9ef">$(</span>NAME<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>VERSION<span style="color:#66d9ef">)</span>
<span style="color:#75715e"># NB: add &#34;host.docker.internal:5000&#34; to insecure registries in Docker Settings</span>
docker push host.docker.internal:5000/example/<span style="color:#66d9ef">$(</span>NAME<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>VERSION<span style="color:#66d9ef">)</span></code></pre></div>
<p>Here we are forwarding laptop port 5000 to port localhost:5000 on <code>registry.example.com</code>.
That's the Registry running on the server.</p>

<p>This script has a little bit of magic so let me highlight a few things.
<code>host.docker.internal</code> is a special Docker hostname which I think means &quot;the actual host OS Docker is running on&quot; since localhost is specific to each container.
The SSH tunnel does not shut down automatically so I have to kill it manually, email me if you know how to fix that.
You have to add <code>host.docker.internal</code> to Docker's list of insecure registries so you can push without TLS.
We don't need TLS since we are using an SSH tunnel but Docker doesn't know that.</p>

<h2 id="customer-access">Customer Access</h2>

<p>Let's wave our hands a bit: now you have an accessible registry, yay!
Assume <code>foobar</code> is a user in the fpro or fent passwd files:</p>

<pre><code>$ docker login registry.example.com
Username: foobar
Password: abc123

$ docker pull registry.example.com/example/somename:1.5.0
...
</code></pre>

<p>If the customer stops paying, you remove them from the passwd file and they lose the ability to pull images.
That's pretty straightfoward, a nice developer experience.</p>

<h2 id="redundancy">Redundancy</h2>

<p>I run several identical servers A, B and C so that if one does down, any of the others can take over a service.
The Registry limits itself to serving static files from one directory tree (e.g. <code>/var/www/docker</code>).
Pushing an image adds files to that directory tree.
I configured that directory to be replicated across all my servers so when I push an image, all servers get a copy of the image within seconds.
If server A goes down, server B can take over as <code>registry.example.com</code> with a quick DNS swap.</p>

<h2 id="conclusion">Conclusion</h2>

<p>All this took me a few days to figure out and develop but I have been very happy with the result.
Yes I had to install Docker on my server but I've had zero problems with it so far and it takes very little resources to run.
In return, Faktory installation and deployment have become much simpler for my customers using Docker.</p>

        
      </div>
    </div>
    <footer class="site-footer">
	<div class="container">
		<h4>Mike Perham</h4>
		<div class="row">
			<div class="col-md-3">
				<div class="form-group">
					<p>Ruby, OSS and the Internet</p>
					<a href="mailto:mperham@gmail.com">mperham@gmail.com</a>
				</div>
			</div>
			<div class="col-md-4">
				<div class="form-group">
					<p>
						<span class="fa fa-fw fa-github"></span>
						<a href="https://github.com/mperham">mperham</a>
            <br/>
						<span class="fa fa-fw fa-twitter"></span>
            <a href="https://twitter.com/@sidekiq">@sidekiq</a>
					</p>
				</div>
			</div>
		</div>
	</div>
</footer>

    <script src="https://www.mikeperham.com/js/jquery-2.1.4.min.js"></script>
<script src="https://www.mikeperham.com/js/bootstrap.min.js"></script>

  </body>
</html>
