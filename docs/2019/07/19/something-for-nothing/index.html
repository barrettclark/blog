  <!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> Something For Nothing </title>
    
    <link rel="stylesheet" href="https://www.mikeperham.com/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://www.mikeperham.com/css/theme.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/headshot-icon.png">
    <link rel="shortcut icon" href="/favicon.ico">
    
    
    
    <link href="https://www.mikeperham.com/index.xml" rel="home" type="application/rss+xml" title="Mike Perham" />
    
</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-right">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://www.mikeperham.com">Mike Perham</a>
    </div>
    <div class="collapse navbar-collapse" id="navbar-right">
      <ul class="nav navbar-nav navbar-right">
        
          <li><a href="https://sidekiq.org/" >Sidekiq</a></li>
        
          <li><a href="http://contribsys.com/faktory/" >Faktory</a></li>
        
          <li><a href="/events/" >Events</a></li>
        
          <li><a href="/about/" >About</a></li>
        
        
        <li><a href="https://www.mikeperham.com/index.xml" title="RSS" type="application/rss+xml" target="_blank"><i class="fa fa-fw fa-rss"></i></a></li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="container page-wrap">
      <h1>Something For Nothing</h1>
      <small class="post-meta">Jul 19, 2019</small>
      <div class="post-content">
        

<p><img style="float: right; padding: 10px" src="/images/freebeer.jpg" alt="freebeer"/></p>

<p>Do you like free things? Would you like to get something for nothing?
Are you a Sidekiq user? If you answered yes to these questions, I have a
case study in how one customer effectively got Sidekiq Enterprise for
free.</p>

<p>One Friday morning, two engineers jumped into my weekly Happy Hour to ask me about a Sidekiq problem they were having.</p>

<blockquote>
<p>&quot;We have two Sidekiq dynos with 40 threads each: we find that after about 5 minutes, they are only using about 20 threads; shouldn't all 40 threads pick up jobs? The jobs perform image processing.&quot;</p>
</blockquote>

<pre><code>bundle exec sidekiq -c 40
</code></pre>

<p>They were using two Heroku <code>performance-m</code> dynos, which cost $250/month each.</p>

<h2 id="mri-has-a-limit">MRI has a Limit</h2>

<p>If you are a Ruby expert, you might already have an idea of what's going
wrong but the crux is this: <strong>one MRI process will only use a single core</strong>.
Now consider <strong>image processing is often CPU intensive</strong>.
They were crushing a single core on each performance-m dyno while the rest of the cores sat there doing nothing.
Those extra 20 threads weren't lazy -- they literally couldn't get any CPU time scheduled!</p>

<h2 id="multi-process-to-the-rescue">Multi-Process to the Rescue</h2>

<p>The answer was easy since they were a Sidekiq Enterprise customer:</p>

<pre><code>bundle exec sidekiqswarm -c 20
</code></pre>

<p><code>sidekiqswarm</code> is a special binary which <a href="https://github.com/mperham/sidekiq/wiki/Ent-Multi-Process">forks a Sidekiq process for
each core on the
dyno</a>. We reduce the thread count so each core
isn't crushed by image processing.</p>

<p>In summary:</p>

<table>
<thead>
<tr>
<th></th>
<th>Before</th>
<th>After</th>
</tr>
</thead>

<tbody>
<tr>
<td>Dynos</td>
<td>2</td>
<td>1</td>
</tr>

<tr>
<td>Threads</td>
<td>80 (2 x 40)</td>
<td>80 (4 x 20)</td>
</tr>

<tr>
<td>Core usage</td>
<td>50%</td>
<td>100%</td>
</tr>

<tr>
<td>Cost</td>
<td>$500</td>
<td>$250 + $179</td>
</tr>

<tr>
<td>Savings</td>
<td></td>
<td>$71/mo</td>
</tr>
</tbody>
</table>

<p>Before they had 1 busy core and 3 idle cores on each dyno.  Now they
have 4 busy cores and can spin down the second dyno instance to save
$250/mo. Since Sidekiq Enterprise costs $179/mo, this change paid for
Sidekiq Enterprise, saved an additional $71/mo and ensured that future worker dynos are fully utilized.</p>

<p>If you are using Performance dynos and not using Sidekiq Enterprise, you
are likely paying for too many dynos.  <a href="https://billing.contribsys.com/sent/new.cgi">Purchasing Sidekiq Enterprise</a> and
using <code>sidekiqswarm</code> to reduce your dyno count may cover the entire
purchase price.  You get all the Sidekiq Pro and Enterprise features
effectively for free.  Each sale has a 14 day money back guarantee if
you want to try it today.</p>

        
      </div>
    </div>
    <footer class="site-footer">
	<div class="container">
		<h4>Mike Perham</h4>
		<div class="row">
			<div class="col-md-3">
				<div class="form-group">
					<p>Ruby, OSS and the Internet</p>
					<a href="mailto:mperham@gmail.com">mperham@gmail.com</a>
				</div>
			</div>
			<div class="col-md-4">
				<div class="form-group">
					<p>
						<span class="fa fa-fw fa-github"></span>
						<a href="https://github.com/mperham">mperham</a>
            <br/>
						<span class="fa fa-fw fa-twitter"></span>
            <a href="https://twitter.com/@sidekiq">@sidekiq</a>
					</p>
				</div>
			</div>
		</div>
	</div>
</footer>

    <script src="https://www.mikeperham.com/js/jquery-2.1.4.min.js"></script>
<script src="https://www.mikeperham.com/js/bootstrap.min.js"></script>

  </body>
</html>
